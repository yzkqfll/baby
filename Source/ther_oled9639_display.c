
#include "Comdef.h"
#include "OSAL.h"
#include "hal_board.h"

#include "ther_uart.h"
#include "ther_uart_comm.h"

#include "thermometer.h"
#include "ther_oled9639_display.h"
#include "ther_oled9639_drv.h"

#define MODULE "[OLED DISPLAY] "

struct oled_display {
	bool device_init;
};

static struct oled_display display = {
	.device_init = FALSE,
};

static unsigned char welcome_96_39[] = {
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0x60, 0xB0, 0xD8, 0xE8, 0xF4, 0xFA, 0xFB, 0xFD, 0xFD, 0xFE, 0xFE, 0xFE, 0x7E, 0x7F, 0x7F, 0xFF, 0xBF, 0xBF, 0xBF, 0xBF, 0xFF, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xC0, 0x70, 0xB8, 0xD0, 0xEC, 0xF4, 0xFF, 0xFB, 0xFD, 0xFD, 0xFE, 0xFE, 0xFE, 0x7F, 0x7F, 0x7F, 0xFF, 0xBF, 0xBF, 0xBF, 0x3F, 0x3F, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x1E, 0xF7, 0xF9, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x9F, 0xE7, 0x1B, 0x19, 0x1D, 0x06, 0x06, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x60, 0x9E, 0xF7, 0xFD, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x5F, 0x67, 0x1B, 0x79, 0x75, 0x42, 0x42, 0x42, 0x00, 0x02, 0x02, 0xC2, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0xC1, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x98, 0x00, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x61, 0x7F, 0x1F, 0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0B, 0x3E, 0xFB, 0xEF, 0xDF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFB, 0xF6, 0xEC, 0xDC, 0xD8, 0xB0, 0x80, 0xA0, 0x60, 0x40, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0C, 0x13, 0xEF, 0xDF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFB, 0xF6, 0xEE, 0xDC, 0xD8, 0xB8, 0xB8, 0xA0, 0x00, 0x00, 0x00, 0x40, 0x40, 0x00, 0x80, 0xC0, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0E, 0x05, 0x09, 0x0B, 0x17, 0x27, 0x2F, 0x1F, 0x1F, 0x1F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x40, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0A, 0x0D, 0x0F, 0x0B, 0x37, 0x3F, 0x2F, 0x3F, 0x1F, 0x1F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static unsigned char battery_16_20[][40] = {
		0x00, 0x00, 0xF8, 0xFC, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0xF4, 0xF4, 0x04, 0xFC, 0x00, 0x00, 0x00, 0x01, 0x03, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x03, 0x00
};

static unsigned char bluetooth_16_10[][20] = {
		0x00, 0x04, 0x08, 0x10, 0x60, 0xFE, 0x84, 0x48, 0x30, 0x00, 0x00, 0x20, 0x10, 0x08, 0x06, 0x3F, 0x21, 0x12, 0x0C, 0x00
};

static unsigned char dummy_celsius_24x13[39] = {
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

static unsigned char celsius_24_8[][24] = {
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0E, 0x1F, 0x1F, 0x1F, 0x1F, 0x0E, 0x00
};

static unsigned char du_24_20[][60] = {
		0x00, 0x00, 0x30, 0x48, 0x48, 0x30, 0x00, 0xC0, 0xE0, 0x60, 0x30, 0x30, 0x30, 0x30, 0x30, 0x60, 0xE0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0x18, 0x30, 0x30, 0x30, 0x30, 0x30, 0x38, 0x1E, 0x0E, 0x00, 0x00
};


static unsigned char number8_16_10[][20] = {
		0x00, 0x00, 0x78, 0x84, 0x84, 0x84, 0x84, 0x78, 0x00, 0x00, 0x00, 0x00, 0x1E, 0x21, 0x21, 0x21, 0x21, 0x1E, 0x00, 0x00
};

/*
 * Font 0 ~ 9
 *
 * 24 X 13 pix
 */
static unsigned char number_24x13[][39] = {
	/* 0 */
	0x00, 0x00, 0xE0, 0xF0, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x1F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x1F, 0x0F, 0x00, 0x00,

	/* 1 */
	0x00, 0x00, 0x00, 0x20, 0x30, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x30, 0x3F, 0x3F, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00,

	/* 2 */
	0x00, 0x00, 0x30, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0x70, 0x38, 0x18, 0x1F, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00,

	/* 3 */
	0x00, 0x00, 0x20, 0x30, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF8, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x08, 0x18, 0x30, 0x30, 0x30, 0x30, 0x38, 0x1F, 0x0F, 0x00, 0x00,

	/* 4 */
	0x00, 0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x00, 0x00, 0x00, 0x00,

	/* 5 */
	0x00, 0x00, 0xE0, 0xF0, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x1F, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF8, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x38, 0x3F, 0x1F, 0x00, 0x00,

	/* 6 */
	0x00, 0x00, 0xC0, 0xE0, 0x70, 0x38, 0x18, 0x18, 0x18, 0x18, 0x10, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xE0, 0x70, 0x30, 0x30, 0x30, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x1F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3F, 0x1F, 0x00, 0x00,

	/* 7 */
	0x00, 0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0x70, 0x38, 0x1C, 0x0F, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,

	/* 8 */
	0x00, 0x00, 0xE0, 0xF0, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x83, 0xC7, 0x6C, 0x38, 0x38, 0x38, 0x6C, 0xC7, 0x83, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x1F, 0x30, 0x30, 0x30, 0x30, 0x30, 0x1F, 0x0F, 0x00, 0x00,

	/* 9 */
	0x00, 0xE0, 0xF0, 0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0xF8, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x1F, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1C, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3F, 0x3F, 0x00, 0x00
};


static void oled_show_time(bool show)
{
	if (show) {
		oled_drv_write_block(0, 2, 15, 25, number8_16_10[0]);
		oled_drv_write_block(0, 2, 26, 36, number8_16_10[0]);

		oled_drv_write_block(0, 2, 37, 47, number8_16_10[0]);
		oled_drv_write_block(0, 2, 48, 58, number8_16_10[0]);
	} else {
		oled_drv_fill_block(0, 2, 15, 58, 0);
	}
}

/*
 * 277 => 27.7 du
 */
static void oled_show_temp(bool show, unsigned short temp)
{
	unsigned char ten_digit, single_digit, decimal;

	ten_digit = temp / 100;
	single_digit = (temp % 100) / 10;
	decimal = temp % 10;

	if (show) {
		oled_drv_write_block(2, 5, 10, 23, number_24x13[ten_digit]);
		oled_drv_write_block(2, 5, 23, 36, number_24x13[single_digit]);

		oled_drv_write_block(2, 5, 39, 47, celsius_24_8[0]);

		oled_drv_write_block(2, 5, 50, 63, number_24x13[decimal]);

		oled_drv_write_block(2, 5, 65, 85, du_24_20[0]);
	} else {
		oled_drv_fill_block(2, 5, 10, 85, 0);
	}


}

static void oled_show_dumy_temp(bool show)
{
	if (show) {
		oled_drv_write_block(2, 5, 10, 23, dummy_celsius_24x13);
		oled_drv_write_block(2, 5, 23, 36, dummy_celsius_24x13);

		oled_drv_write_block(2, 5, 39, 47, celsius_24_8[0]);

		oled_drv_write_block(2, 5, 50, 63, dummy_celsius_24x13);

		oled_drv_write_block(2, 5, 65, 85, du_24_20[0]);
	} else {
		oled_drv_fill_block(2, 5, 10, 85, 0);
	}
}

static void oled_show_batt(bool show, unsigned char level)
{
	if (show)
		oled_drv_write_block(0, 2, 69, 89, battery_16_20[0]);
	else
		oled_drv_fill_block(0, 2, 69, 89, 0);
}

static void oled_show_bluetooth(bool show)
{
	if (show)
		oled_drv_write_block(0, 2, 0, 10, bluetooth_16_10[0]);
	else
		oled_drv_fill_block(0, 2, 0, 10, 0);
}

void oled_test(void)
{
	oled_drv_fill_block(0, 1, 0, MAX_COL, 0);
	oled_drv_fill_block(1, 2, 0, MAX_COL, 0xff);
	oled_drv_fill_block(2, 3, 0, MAX_COL, 0);
	oled_drv_fill_block(3, 4, 0, MAX_COL, 0xff);
	oled_drv_fill_block(4, MAX_PAGE, 0, MAX_COL, 0);
}

/*
 * used when picture switch
 *
 * so need to check <device init> ????
 */
void oled_clear_screen(void)
{
	oled_drv_fill_block(0, MAX_PAGE, 0, MAX_COL, 0);
}

void oled_show_first_picture(unsigned short time, unsigned char link,
						unsigned char batt_level, unsigned short temp)
{
	struct oled_display *od = &display;

	if (!od->device_init) {
		oled_drv_init_device();
		od->device_init = TRUE;
	}

	oled_show_time(TRUE);

	if (link == LINK_ON)
		oled_show_bluetooth(TRUE);
	else
		oled_show_bluetooth(FALSE);

	oled_show_batt(TRUE, batt_level);

	oled_show_temp(TRUE, temp);

	oled_drv_display_on();
}

void oled_update_first_picture(unsigned char type, unsigned short val)
{
	switch (type) {
	case OLED_CONTENT_TIME:
		break;

	case OLED_CONTENT_LINK:
		break;

	case OLED_CONTENT_BATT:
		break;

	case OLED_CONTENT_TEMP:
		oled_show_temp(TRUE, val);

		break;

	case OLED_CONTENT_DUMMY_TEMP:
		oled_show_dumy_temp(TRUE);
		break;

	default:
		break;
	}
}

void oled_show_second_picture(void)
{
	struct oled_display *od = &display;

	if (!od->device_init) {
		oled_drv_init_device();
		od->device_init = TRUE;
	}

	print(LOG_DBG, "111\r\n");
	oled_test();
	print(LOG_DBG, "222\r\n");

	oled_drv_display_on();
}

void oled_show_welcome(void)
{
	struct oled_display *od = &display;

	if (!od->device_init) {
		oled_drv_init_device();
		od->device_init = TRUE;
	}

	// TODO
//	oled_drv_write_block(0, MAX_PAGE, 0, MAX_COL, welcome_96_39);
	oled_drv_fill_block(0, 4, 0, MAX_COL, 0xff);

	oled_drv_display_on();
}

void oled_show_goodbye(void)
{
	struct oled_display *od = &display;

	if (!od->device_init) {
		oled_drv_init_device();
		od->device_init = TRUE;
	}

	// TODO
	oled_drv_fill_block(4, 5, 0, MAX_COL, 0xff);

	oled_drv_display_on();
}

void oled_power_on(void)
{
	oled_drv_power_on();
}

void oled_power_off(void)
{
	struct oled_display *od = &display;

	oled_drv_display_off();
	oled_drv_power_off();

	od->device_init = FALSE;
}



void oled_display_init(void)
{
	print(LOG_INFO, MODULE "oled9639 display init\r\n");

	oled_drv_init();
}
